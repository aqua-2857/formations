<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·¨æˆè¡¨ï½¥è»Šæ­´è¡¨</title>

ã€€<meta name="description" content="é‰„é“è»Šä¸¡ã®ç·¨æˆè¡¨ã¨è»Šæ­´ãŒã¾ã¨ã‚ã¦ã‚ã‚‹ã‚µã‚¤ãƒˆã€‚æ—¥ã€…è¿½åŠ ã€æ›´æ–°ä¸­ã€‚">

    <link rel="icon" href="image/icon.png">
    <link rel="apple-touch-icon" href="image/icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1c1c1c">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <meta name="apple-mobile-web-app-title" content="ç·¨æˆè¡¨ï½¥è»Šæ­´è¡¨">
    
    <style>
        :root { 
            --header-bg: #1c1c1c; 
            --main-bg: #f0f0f0; 
            --text-main: #333333;
            --sub-gray: #808080;
            --bar-bg: #333333;
            --accent-color: #444444;
        }

        body { font-family: sans-serif; background: var(--main-bg); margin: 0; color: var(--text-main); -webkit-tap-highlight-color: transparent; }
        
        .header { 
            background: var(--header-bg); 
            color: white; 
            padding: 0 15px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            height: 56px;
            font-size: 1.1rem; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
        }

        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒœã‚¿ãƒ³ */
        .menu-btn {
            width: 44px;
            height: 44px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            z-index: 200;
        }
        .menu-btn span {
            display: block;
            width: 24px;
            height: 2px;
            background-color: white;
            transition: 0.3s;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .nav-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 250px;
            height: 100%;
            background: rgba(28, 28, 28, 0.95);
            z-index: 150;
            transition: 0.3s;
            padding-top: 60px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
        }
        .nav-menu.active {
            right: 0;
        }
        .nav-menu-item {
            padding: 20px;
            color: white;
            border-bottom: 1px solid #444;
            cursor: pointer;
            font-size: 16px;
            display: block;
            text-decoration: none;
        }
        .nav-menu-item:active {
            background: var(--accent-color);
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 140;
        }
        .menu-overlay.active {
            display: block;
        }

        /* ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .page-content { padding: 20px; line-height: 1.6; }
        .page-content h2 { font-size: 1.2rem; border-left: 4px solid var(--header-bg); padding-left: 10px; margin-top: 0; }

        /* æ—¢å­˜ã®ãƒªã‚¹ãƒˆè¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .system-section { background: var(--bar-bg); color: white; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; margin-top: 1px; cursor: pointer; }
        .system-title { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .system-icon { width: 35px; height: 35px; background: white; border-radius: 4px; object-fit: contain; flex-shrink: 0; }
        .arrow { transition: transform 0.3s; font-size: 12px; }
        .formation-list-bg { padding: 15px 10px; display: none; }
        .formation-list-bg.show { display: block; }
        .line-sys-row { padding: 15px 5px; cursor: pointer; border-bottom: 1px solid #ccc; font-weight: bold; color: var(--text-main); font-size: 15px; }
        .direction-label { color: var(--sub-gray); font-size: 11px; margin-bottom: 25px; display: flex; justify-content: space-between; font-weight: bold; }
        .formation-row { display: flex; flex-direction: column; align-items: flex-start; gap: 5px; margin-bottom: 25px; cursor: pointer; }
        .f-name-tag { background: none; color: var(--text-main); font-weight: bold; min-width: 45px; text-align: left; font-size: 14px; flex-shrink: 0; }
        .car-mini-list { display: flex; gap: 1px; align-items: flex-end; flex-wrap: wrap; width: 100%; }
        .mini-car-container { position: relative; width: calc((100vw - 30px) / 6.2); max-width: 68px; aspect-ratio: 68 / 48; }
        .mini-panta { position: absolute; width: 14.7%; z-index: 5; top: 12.5%; }
        .mini-panta-l { left: 11.7%; }
        .mini-panta-r { right: 11.7%; }
        .mini-panta.panta-p0 { width: 29.4%; top: 12.5%; }
        .mini-panta-l.panta-p0 { left: 4.4%; }
        .mini-panta-r.panta-p0 { right: 4.4%; }
        .mini-panta.low-panta { top: 22.9%; } 
        .mini-bogie { position: absolute; width: 23.5%; z-index: 5; bottom: 12.5%; }
        .mini-bogie-l { left: 11.7%; }
        .mini-bogie-r { right: 11.7%; }
        .mini-car-body { width: 100%; height: 58.3%; position: absolute; bottom: 20.8%; z-index: 10; background-size: contain; background-repeat: no-repeat; background-position: bottom; }
        .mini-info-in-body { position: absolute; bottom: 37.5%; width: 100%; text-align: center; z-index: 20; color: white; font-weight: bold; font-size: min(8px, 1.8vw); text-shadow: 1px 1px 1px rgba(0,0,0,0.8); white-space: nowrap; pointer-events: none; }
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: var(--text-main); }
        .detail-info-box { padding: 20px; color: var(--text-main); line-height: 1.6; font-size: 14px; }
        .info-row { display: flex; margin-bottom: 5px; }
        .info-label { width: 100px; color: var(--sub-gray); flex-shrink: 0; }
        .stamp-icon-large { height: 32px; }
        .divider { height: 1px; background-color: var(--sub-gray); margin: 10px 20px; }
        .car-detail-list { padding: 0 10px; }
        .car-unit { display: flex; flex-direction: column; margin-bottom: 45px; }
        .car-visual-row { display: flex; align-items: center; gap: 8px; }
        .car-img-container { position: relative; width: 160px; height: 80px; flex-shrink: 0; cursor: pointer; }
        .detail-car-body { width: 100%; height: 50px; position: absolute; bottom: 14px; z-index: 10; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .car-no-inline { position: absolute; top: calc(52% - 3px); left: 50%; transform: translate(-50%, -50%); z-index: 20; color: white; font-size: 14px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,1); white-space: nowrap; }
        .panta-detail { position: absolute; top: -5px; width: 22px; z-index: 5; } 
        .panta-left { left: 22px; }
        .panta-right { right: 22px; }
        .panta-detail.panta-p0 { width: 44px; top: -5px; }
        .panta-left.panta-p0 { left: 11px; }
        .panta-right.panta-p0 { right: 11px; }
        .panta-detail.low-panta { top: 5px; } 
        .bogie { position: absolute; bottom: 4px; width: 40px; z-index: 5; }
        .bogie-left { left: 22px; }
        .bogie-right { right: 22px; }
        .car-meta { font-size: 12px; color: #333333; font-weight: bold; flex-grow: 1; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .car-data-row { display: flex; align-items: center; gap: 12px; margin-top: 8px; font-size: 13px; color: #333333; }
        .stamp-small { height: 32px; }
        .history-section { border-top: 1px solid var(--sub-gray); margin-top: 20px; padding: 20px; }
        .history-item { margin-bottom: 18px; }
        .history-top-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .history-date { font-size: 13px; font-weight: bold; color: var(--text-main); white-space: nowrap; }
        .history-stamp { height: 26px; }
        .history-desc { font-size: 13px; color: #333; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>
<div class="nav-menu" id="nav-menu">
    <div class="nav-menu-item" onclick="showAbout()">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</div>
    <div class="nav-menu-item" onclick="location.reload();">ãƒªãƒ­ãƒ¼ãƒ‰</div>
</div>

<div id="home-view">
    <div class="header">
        <span>ãƒ›ãƒ¼ãƒ </span>
        <div class="menu-btn" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </div>
    </div>
    <div id="accordion-container"></div>
</div>

<div id="formation-view" class="hidden">
    <div class="header">
        <span onclick="showHome()" style="cursor:pointer;">â—€ <span id="formation-header-title">ç³»çµ±å</span></span>
        <div class="menu-btn" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </div>
    </div>
    <div id="formation-accordion-container"></div>
</div>

<div id="detail-view" class="hidden">
    <div class="header">
        <span onclick="showFormation()" style="cursor:pointer;">â—€ <span id="detail-header-title">ç·¨æˆå</span></span>
        <div class="menu-btn" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </div>
    </div>
    <div class="detail-info-box">
        <div class="section-title">ç·¨æˆæƒ…å ±</div>
        <div class="info-row"><span class="info-label">è»Šä¸¡å½¢å¼</span> <span id="info-type"></span></div>
        <div class="info-row"><span class="info-label">æ‰€å±åŸºåœ°</span> <span id="info-base"></span></div>
        <div class="info-row" id="atacs-row"><span class="info-label">ATACS-ID</span> <span id="info-atacs"></span></div>
        <div id="info-stamps" style="margin-top:12px; display:flex; align-items:center; gap:8px;"></div>
    </div>
    <div class="divider"></div>
    <div class="car-detail-list"><div id="car-details-container"></div></div>
    <div class="history-section">
        <div class="section-title" id="history-title">è»Šæ­´</div>
        <div id="history-list"></div>
    </div>
</div>

<div id="about-view" class="hidden">
    <div class="header">
        <span onclick="showHome()" style="cursor:pointer;">â—€ ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</span>
        <div class="menu-btn" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </div>
    </div>
    <div class="page-content">
        <h2>ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</h2>
        <p> æœ¬ã‚µã‚¤ãƒˆã¯ã€é‰„é“è»Šä¸¡ã®ç·¨æˆã€è»Šæ­´ã‚’ã¾ã¨ã‚ãŸã‚µã‚¤ãƒˆã§ã™ã€‚æ—¥ã€…ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã€æ›´æ–°ä¸­ã§ã™ã€‚ </p> 

 <p> æœ¬ã‚µã‚¤ãƒˆãªã‚‰ã³ã«ãƒ‡ãƒ¼ã‚¿ã¯å€‹äººã®è¶£å‘³ã§åˆ¶ä½œãƒ»é‹å–¶ã•ã‚Œã¦ãŠã‚Šã€å„é‰„é“ä¼šç¤¾ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚ </p> 

 <p> æœ¬ã‚µã‚¤ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯ã€è‡ªã‚‰èª¿æŸ»ã—ãŸæƒ…å ±ã®ã»ã‹ã€å…¬è¡¨ã•ã‚Œã¦ã„ã‚‹å„ç¨®è³‡æ–™ã€é‰„é“é›‘èªŒã€ãŠã‚ˆã³SNSç­‰ã«ã‚ˆã‚‹ç›®æ’ƒæƒ…å ±ç­‰ã‚’é›†è¨ˆãƒ»æ•´ç†ã—ãŸã‚‚ã®ã§ã™ã€‚æƒ…å ±ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯ç´°å¿ƒã®æ³¨æ„ã‚’æ‰•ã£ã¦ãŠã‚Šã¾ã™ãŒã€ãã®å†…å®¹ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸‡ãŒä¸€ã€æƒ…å ±ã®èª¤ã‚Šã«ã‚ˆã£ã¦æå®³ãŒç”Ÿã˜ãŸå ´åˆã§ã‚‚ã€åˆ¶ä½œè€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã‹ã­ã¾ã™ã€‚ </p> 

 <p> ã‚¢ã‚¤ã‚³ãƒ³ã€ç”»åƒãƒ‡ãƒ¼ã‚¿ç­‰ã¯åˆ¶ä½œè€…ãŒä½œæˆã—ãŸã‚‚ã®ã§ã‚ã‚Šã€è‘—ä½œæ¨©ã¯åˆ¶ä½œè€…ã«å¸°å±ã—ã¾ã™ã€‚è»¢è¼‰ã¯è‡ªç”±ã§ã™ãŒã€åˆ¶ä½œè€…ã‚„å¼•ç”¨å…ƒã‚’è¨˜è¼‰ã—ã¦ã„ãŸã ã‘ã‚‹ã¨ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚ã¾ãŸã€å•†ç”¨ç›®çš„ã§ã®åˆ©ç”¨ã¯å›ºããŠæ–­ã‚Šã—ã¾ã™ã€‚ </p> 

 <p> ãŠå•ã„åˆã‚ã›ã¯Twitter(ç¾ğ•)ã®DMã‹ã‚‰ãŠé¡˜ã„ã—ã¾ã™ã€‚ </p> 

 <p> <a href="https://x.com/aqua_2857s?s=21" target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none; padding: 10px; display: inline-block;">
<img src="image/x.png"
alt="icon" style= "height: 0.8em; width: auto; object-fit: contain; margin-right:
8px; ">
<span style="font-weight:
bold; font-size: 16pxï¼š ">
ãƒŸã‚ºã‚¤ãƒ«ã‚«
<img src="image/link.png"
alt="icon" style= "height: 0.8em; width: auto; object-fit: contain; margin-right:
8px; ">
<span style="font-weight:
bold; font-size: 16pxï¼š "> </span>
</ a>
</div>

        <div id="last-update" style="font-size: 12px; color: #808080; padding: 10px;"></div>

<script>
  
    const lastUpdate = new Date(document.lastModified);
    const year = lastUpdate.getFullYear();
    const month = lastUpdate.getMonth() + 1;
    const day = lastUpdate.getDate();
    const hour = ("0" + lastUpdate.getHours()).slice(-2);
    const min = ("0" + lastUpdate.getMinutes()).slice(-2);

    document.getElementById('last-update').innerText = 
        `æœ€çµ‚æ›´æ–°: ${year}å¹´${month}æœˆ${day}æ—¥ ${hour}:${min}`;
</script>

</divâ€º
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
let formationData = [];
let carIdMap = {}; 
let historyData = []; 
let currentSystem = "";
let currentCars = [];
let fullHistoryEvents = []; 
const PANTA_MAP = { 'â—‡': 'p0', 'ï¼œ': 'p1', 'ï¼': 'p2', '<': 'py1', '>': 'py2' };

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»è¡¨ç¤ºåˆ‡æ›¿
function toggleMenu() {
    document.getElementById('nav-menu').classList.toggle('active');
    document.getElementById('menu-overlay').classList.toggle('active');
}

function hideAllViews() {
    document.getElementById('home-view').classList.add('hidden');
    document.getElementById('formation-view').classList.add('hidden');
    document.getElementById('detail-view').classList.add('hidden');
    document.getElementById('about-view').classList.add('hidden');
}

function showHome() {
    hideAllViews();
    document.getElementById('home-view').classList.remove('hidden');
}

function showFormation() {
    hideAllViews();
    document.getElementById('formation-view').classList.remove('hidden');
}

function showAbout() {
    hideAllViews();
    document.getElementById('about-view').classList.remove('hidden');
    toggleMenu(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
}

// ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
function loadAllData() {
    return new Promise((resolve) => {
        Papa.parse('file - formation.csv', {
            download: true, header: true, skipEmptyLines: 'greedy',
            complete: function(fResults) {
                formationData = fResults.data.filter(r => r.ä¼šç¤¾å && r.ä¼šç¤¾å.trim() !== "");
                
                Papa.parse('file - car_id.csv', {
                    download: true, header: true, skipEmptyLines: 'greedy',
                    complete: function(cResults) {
                        cResults.data.forEach(row => {
                            if(row['è»Šä¸¡ID']) carIdMap[row['è»Šä¸¡ID']] = row;
                        });

                        Papa.parse('file - history.csv', {
                            download: true, header: true, skipEmptyLines: 'greedy',
                            complete: function(hResults) {
                                historyData = hResults.data;
                                resolve();
                            }
                        });
                    }
                });
            }
        });
    });
}

loadAllData().then(() => {
    renderHome();
});

// ä»¥é™ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ»ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢æ•°ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜
function formatDateJP(dateStr) {
    if (!dateStr || dateStr.trim() === "") return "";
    const parsePart = (part, context = {}) => {
        const segments = part.split('/');
        let y = context.y, m = context.m, d = context.d;
        if (segments.length === 3) {
            y = segments[0]; m = segments[1]; d = segments[2];
        } else if (segments.length === 2) {
            if (segments[0].length === 4) { y = segments[0]; m = segments[1]; d = null; }
            else { m = segments[0]; d = segments[1]; }
        } else if (segments.length === 1) { d = segments[0]; }
        return { y, m, d };
    };
    const stringify = (obj) => {
        let res = "";
        if (obj.y) res += obj.y + "å¹´";
        if (obj.m) res += obj.m + "æœˆ";
        if (obj.d) res += obj.d + "æ—¥";
        return res;
    };
    if (dateStr.includes('-')) {
        const parts = dateStr.split('-');
        const start = parsePart(parts[0]);
        const end = parsePart(parts[1], start);
        return stringify(start) + "~" + stringify(end);
    } else {
        return stringify(parsePart(dateStr));
    }
}

function getStampsHTML(stampStr, className, folder = 'stamp') {
    if (!stampStr) return '';
    return stampStr.split(',').map(s => `<img src="${folder}/${s.trim()}.png" class="${className}" onerror="this.style.display='none'">`).join('');
}

function renderHome() {
    const container = document.getElementById('accordion-container');
    container.innerHTML = '';
    const companies = [...new Set(formationData.map(r => r.ä¼šç¤¾å))];
    companies.forEach(com => {
        const comId = `com-${com.replace(/\s+/g, '')}`;
        container.insertAdjacentHTML('beforeend', `
            <div class="system-section" onclick="toggleSection('${comId}', this)">
                <div class="system-title">${com}</div>
                <div class="arrow">â–¼</div>
            </div>
            <div id="${comId}" class="formation-list-bg">
                <div class="rows-container"></div>
            </div>`);
        const rowsContainer = container.querySelector(`#${comId} .rows-container`);
        const comData = formationData.filter(r => r.ä¼šç¤¾å === com);
        const systems = [...new Set(comData.map(r => r.è·¯ç·šç³»çµ±))];
        systems.forEach(sys => {
            const row = document.createElement('div');
            row.className = 'line-sys-row';
            row.innerText = sys;
            row.onclick = () => showFormationList(sys);
            rowsContainer.appendChild(row);
        });
    });
}

function showFormationList(sysName) {
    currentSystem = sysName;
    hideAllViews();
    document.getElementById('formation-view').classList.remove('hidden');
    document.getElementById('formation-header-title').innerText = sysName;
    window.scrollTo(0,0);

    const fContainer = document.getElementById('formation-accordion-container');
    fContainer.innerHTML = '';
    
    const sysData = formationData.filter(r => r.è·¯ç·šç³»çµ± === sysName);
    const formKeys = [...new Set(sysData.map(r => `${r.å½¢å¼}|${r.è¦‹å‡ºã—ã‚¢ã‚¤ã‚³ãƒ³ || ''}`))];

    formKeys.forEach((key, index) => {
        const [formName, iconName] = key.split('|');
        const formId = `form-${index}-${formName.replace(/\s+/g, '')}`;
        const formData = sysData.filter(r => r.å½¢å¼ === formName && (r.è¦‹å‡ºã—ã‚¢ã‚¤ã‚³ãƒ³ || '') === iconName);
        const first = formData[0];

        fContainer.insertAdjacentHTML('beforeend', `
            <div class="system-section" onclick="toggleSection('${formId}', this)">
                <div class="system-title">
                    ${iconName ? `<img src="icon/${iconName}.png" class="system-icon">` : ''}
                    ${formName}
                </div>
                <div class="arrow">â–¼</div>
            </div>
            <div id="${formId}" class="formation-list-bg">
                <div class="direction-label"><span>â—€ï¸${first.å·¦æ–¹å‘||''}</span><span>${first.å³æ–¹å‘||''}â–¶ï¸</span></div>
                <div class="rows-box"></div>
            </div>`);

        const rowsBox = fContainer.querySelector(`#${formId} .rows-box`);
        const namesWithPeriod = [...new Set(formData.map(r => `${r.ç·¨æˆå}|${r.å§‹ || ''}|${r.çµ‚ || ''}|${r.ä¼šç¤¾å}`))];

        namesWithPeriod.forEach(keyStr => {
            const [name, start, end, company] = keyStr.split('|');
            const cars = formData.filter(r => r.ç·¨æˆå === name && (r.å§‹ || '') === start && (r.çµ‚ || '') === end && r.ä¼šç¤¾å === company).sort((a,b) => a.å·è»Š - b.å·è»Š);
            
            const row = document.createElement('div');
            row.className = 'formation-row';
            row.onclick = () => renderDetail(name, start, end, company);

            const periodLabel = (start || end) ? ` (${start||''}ã€œ${end||''})` : '';
            let h = `<div class="f-name-tag">${name}${periodLabel}</div><div class="car-mini-list">`;
            cars.forEach(c => {
                const lp = PANTA_MAP[c.å·¦ãƒ‘ãƒ³ã‚¿];
                const rp = PANTA_MAP[c.å³ãƒ‘ãƒ³ã‚¿];
                const lastNo = c.è»Šä¸¡ç•ªå· ? c.è»Šä¸¡ç•ªå·.split('-').pop() : "";
                h += `<div class="mini-car-container">
                    ${lp ? `<img src="parts/${lp}.png" class="mini-panta mini-panta-l ${lp === 'p0' ? 'panta-p0' : ''} ${lp.startsWith('py') ? 'low-panta' : ''}">` : ''}
                    ${rp ? `<img src="parts/${rp}.png" class="mini-panta mini-panta-r ${rp === 'p0' ? 'panta-p0' : ''} ${rp.startsWith('py') ? 'low-panta' : ''}">` : ''}
                    <div class="mini-car-body" style="background-image: url('body/${c.è»Šä½“ã‚¢ã‚¤ã‚³ãƒ³}.png');"></div>
                    <div class="mini-info-in-body">${c.ç•¥å·||''}${lastNo}</div>
                    ${c.å·¦å°è»Š ? `<img src="parts/${c.å·¦å°è»Š}.png" class="mini-bogie mini-bogie-l">` : ''}
                    ${c.å³å°è»Š ? `<img src="parts/${c.å³å°è»Š}.png" class="mini-bogie mini-bogie-r">` : ''}
                </div>`;
            });
            row.innerHTML = h + `</div>`;
            rowsBox.appendChild(row);
        });
    });
}

function renderDetail(name, start, end, company) {
    hideAllViews();
    document.getElementById('detail-view').classList.remove('hidden');
    window.scrollTo(0,0);
    
    currentCars = formationData.filter(r => 
        r.ç·¨æˆå === name && 
        (r.å§‹ || '') === start && 
        (r.çµ‚ || '') === end && 
        r.è·¯ç·šç³»çµ± === currentSystem && 
        r.ä¼šç¤¾å === company
    ).sort((a,b) => a.å·è»Š - b.å·è»Š);
    const top = currentCars[0];

    document.getElementById('detail-header-title').innerText = name + ((start || end) ? ` (${start||''}ã€œ${end||''})` : '');
    document.getElementById('info-type').innerText = `${top.å½¢å¼} ${top.ç•ªå° || ''}`.trim();
    document.getElementById('info-base').innerText = top.æ‰€å±åŸºåœ°;

    const atacsRow = document.getElementById('atacs-row');
    if (top["ATACS-ID"] && top["ATACS-ID"].trim() !== "") {
        atacsRow.classList.remove('hidden');
        document.getElementById('info-atacs').innerText = top["ATACS-ID"];
    } else {
        atacsRow.classList.add('hidden');
    }

    document.getElementById('info-stamps').innerHTML = getStampsHTML(top["ç·¨æˆæƒ…å ±(é¸æŠ)"], 'stamp-icon-large');

    const cCon = document.getElementById('car-details-container');
    cCon.innerHTML = '<div class="section-title">è»Šä¸¡æƒ…å ±</div>';
    
    const carIdsInFormation = []; 
    const historyPool = [];

    currentCars.forEach(c => {
        const carId = c.è»Šä¸¡ID;
        carIdsInFormation.push(carId);
        
        const carMeta = carIdMap[carId] || {};
        const lp = PANTA_MAP[c.å·¦ãƒ‘ãƒ³ã‚¿];
        const rp = PANTA_MAP[c.å³ãƒ‘ãƒ³ã‚¿];

        if (carMeta.è½æˆæ—¥ && carMeta.è£½é€ æ‰€) {
            historyPool.push({
                date: carMeta.è½æˆæ—¥,
                stamp: 'rakusei',
                desc: `${carMeta.è£½é€ æ‰€}ã«ã¦è½æˆã€‚`,
                carId: carId,
                carNo: c.è»Šä¸¡ç•ªå·
            });
        }

        cCon.innerHTML += `<div class="car-unit">
            <div class="car-visual-row">
                <div class="car-img-container" onclick="filterHistoryByCar('${carId}', '${c.è»Šä¸¡ç•ªå·}')">
                    ${lp ? `<img src="parts/${lp}.png" class="panta-detail panta-left ${lp === 'p0' ? 'panta-p0' : ''} ${lp.startsWith('py') ? 'low-panta' : ''}">` : ''}
                    ${rp ? `<img src="parts/${rp}.png" class="panta-detail panta-right ${rp === 'p0' ? 'panta-p0' : ''} ${rp.startsWith('py') ? 'low-panta' : ''}">` : ''}
                    <div class="detail-car-body" style="background-image: url('body/${c.è»Šä½“ã‚¢ã‚¤ã‚³ãƒ³}.png');"></div>
                    <div class="car-no-inline">${c.è»Šä¸¡ç•ªå·}</div>
                    ${c.å·¦å°è»Š?`<img src="parts/${c.å·¦å°è»Š}.png" class="bogie bogie-left">`:''}
                    ${c.å³å°è»Š?`<img src="parts/${c.å³å°è»Š}.png" class="bogie bogie-right">`:''}
                </div>
                <div class="car-meta">
                    <div>${carMeta.è£½é€ æ‰€ || ''}</div>
                    <div>${formatDateJP(carMeta.è½æˆæ—¥)}</div>
                </div>
            </div>
            <div class="car-data-row">
                <div class="stamp-container">${getStampsHTML(c["è»Šä¸¡æƒ…å ±(é¸æŠ)"],'stamp-small')}</div>
                <div class="car-desc">${c["è»Šä¸¡æƒ…å ±(è¨˜è¿°)"] || ''}</div>
            </div>
        </div>`;
    });

    historyData.forEach(ev => {
        const eventCarIds = [];
        Object.keys(ev).forEach(key => {
            if(key.startsWith('è»Šä¸¡ID-') && ev[key] && carIdsInFormation.includes(ev[key])) {
                eventCarIds.push(ev[key]);
            }
        });
        if (eventCarIds.length > 0) {
            historyPool.push({
                date: ev.æ—¥ä»˜,
                stamp: ev.ã‚¹ã‚¿ãƒ³ãƒ—,
                desc: ev.è¨˜è¿° || "",
                carIds: eventCarIds
            });
        }
    });

    historyPool.sort((a, b) => (a.date || "").replace(/\//g,'').localeCompare((b.date || "").replace(/\//g,'')));
    
    fullHistoryEvents = [];
    historyPool.forEach(item => {
        const prev = fullHistoryEvents[fullHistoryEvents.length - 1];
        if (prev && prev.date === item.date && prev.desc === item.desc && prev.stamp === item.stamp) {
            if (item.carNo) prev.carNos.push(item.carNo);
            if (item.carIds) item.carIds.forEach(id => { if(!prev.carIds.includes(id)) prev.carIds.push(id); });
        } else {
            fullHistoryEvents.push({
                ...item,
                carNos: item.carNo ? [item.carNo] : [],
                carIds: item.carIds || [item.carId]
            });
        }
    });

    renderHistoryList(fullHistoryEvents);
}

function renderHistoryList(events, title = "è»Šæ­´", isFiltered = false) {
    document.getElementById('history-title').innerText = title;
    const hList = document.getElementById('history-list');
    hList.innerHTML = '';

    events.forEach(ev => {
        const targetCarNos = ev.carNos && ev.carNos.length > 0 ? ev.carNos : currentCars.filter(c => ev.carIds.includes(c.è»Šä¸¡ID)).map(c => c.è»Šä¸¡ç•ªå·);
        
        const suffix = (isFiltered || targetCarNos.length === currentCars.length) ? "" : ` (${targetCarNos.join(', ')})`;
        
        hList.innerHTML += `
            <div class="history-item">
                <div class="history-top-row">
                    <div class="history-date">${formatDateJP(ev.date)}</div>
                    <div class="history-stamp-container">${getStampsHTML(ev.stamp, 'history-stamp', 'history')}</div>
                </div>
                <div class="history-desc">${ev.desc + suffix}</div>
            </div>`;
    });
}

function filterHistoryByCar(carId, carNo) {
    const filtered = fullHistoryEvents.filter(ev => ev.carIds.includes(carId));
    renderHistoryList(filtered, `è»Šæ­´ (${carNo})`, true);
    document.querySelector('.history-section').scrollIntoView({ behavior: 'smooth' });
}

function toggleSection(id, el) {
    const list = document.getElementById(id);
    const isShow = list.classList.toggle('show');
    el.querySelector('.arrow').innerText = isShow ? 'â–²' : 'â–¼';
}
</script>
</body>
</html>
