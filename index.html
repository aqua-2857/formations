<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編成表</title>
    <style>
        :root { 
            --header-bg: #1c1c1c; 
            --main-bg: #f0f0f0; 
            --text-main: #333333;
            --sub-gray: #808080;
            --bar-bg: #333333;
        }

        body { font-family: sans-serif; background: var(--main-bg); margin: 0; color: var(--text-main); -webkit-tap-highlight-color: transparent; }
        
        .header { background: var(--header-bg); color: white; padding: 15px; display: flex; align-items: center; gap: 10px; font-size: 1.1rem; position: sticky; top: 0; z-index: 100; }

        .system-section { background: var(--bar-bg); color: white; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; margin-top: 1px; cursor: pointer; }
        .system-title { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .system-icon { width: 35px; height: 35px; background: white; border-radius: 4px; object-fit: contain; flex-shrink: 0; }
        .arrow { transition: transform 0.3s; font-size: 12px; }

        .formation-list-bg { padding: 15px 10px; display: none; }
        .formation-list-bg.show { display: block; }

        .line-sys-row { padding: 15px 5px; cursor: pointer; border-bottom: 1px solid #ccc; font-weight: bold; color: var(--text-main); font-size: 15px; }

        .direction-label { color: var(--sub-gray); font-size: 11px; margin-bottom: 25px; display: flex; justify-content: space-between; font-weight: bold; }
        
        .formation-row { display: flex; flex-direction: column; align-items: flex-start; gap: 5px; margin-bottom: 25px; cursor: pointer; }
        .f-name-tag { background: none; color: var(--text-main); font-weight: bold; min-width: 45px; text-align: left; font-size: 14px; flex-shrink: 0; }
        
        .car-mini-list { 
            display: flex; 
            gap: 1px; 
            align-items: flex-end; 
            flex-wrap: wrap; 
            width: 100%;
        }

        .mini-car-container { 
            position: relative; 
            width: calc((100vw - 30px) / 6.2); 
            max-width: 68px; 
            aspect-ratio: 68 / 48; 
        }
        
        .mini-panta { position: absolute; width: 14.7%; z-index: 5; top: 12.5%; }
        .mini-panta-l { left: 11.7%; }
        .mini-panta-r { right: 11.7%; }
        .mini-panta.panta-p0 { width: 29.4%; top: 12.5%; }
        .mini-panta-l.panta-p0 { left: 4.4%; }
        .mini-panta-r.panta-p0 { right: 4.4%; }
        .mini-panta.low-panta { top: 22.9%; } 

        .mini-bogie { position: absolute; width: 23.5%; z-index: 5; bottom: 12.5%; }
        .mini-bogie-l { left: 11.7%; }
        .mini-bogie-r { right: 11.7%; }
        .mini-car-body { width: 100%; height: 58.3%; position: absolute; bottom: 20.8%; z-index: 10; background-size: contain; background-repeat: no-repeat; background-position: bottom; }
        
        .mini-info-in-body { position: absolute; bottom: 37.5%; width: 100%; text-align: center; z-index: 20; color: white; font-weight: bold; font-size: min(8px, 1.8vw); text-shadow: 1px 1px 1px rgba(0,0,0,0.8); white-space: nowrap; pointer-events: none; }

        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: var(--text-main); }
        .detail-info-box { padding: 20px; color: var(--text-main); line-height: 1.6; font-size: 14px; }
        .info-row { display: flex; margin-bottom: 5px; }
        .info-label { width: 100px; color: var(--sub-gray); flex-shrink: 0; }
        .stamp-icon-large { height: 32px; }
        
        .divider { height: 1px; background-color: var(--sub-gray); margin: 10px 20px; }
        .car-detail-list { padding: 0 10px; }
        .car-unit { display: flex; flex-direction: column; margin-bottom: 45px; }
        .car-visual-row { display: flex; align-items: center; gap: 8px; }
        .car-img-container { position: relative; width: 160px; height: 80px; flex-shrink: 0; cursor: pointer; }
        .detail-car-body { width: 100%; height: 50px; position: absolute; bottom: 14px; z-index: 10; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .car-no-inline { position: absolute; top: calc(52% - 3px); left: 50%; transform: translate(-50%, -50%); z-index: 20; color: white; font-size: 14px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,1); white-space: nowrap; }
        
        .panta-detail { position: absolute; top: -5px; width: 22px; z-index: 5; } 
        .panta-left { left: 22px; }
        .panta-right { right: 22px; }
        .panta-detail.panta-p0 { width: 44px; top: -5px; }
        .panta-left.panta-p0 { left: 11px; }
        .panta-right.panta-p0 { right: 11px; }
        .panta-detail.low-panta { top: 5px; } 

        .bogie { position: absolute; bottom: 4px; width: 40px; z-index: 5; }
        .bogie-left { left: 22px; }
        .bogie-right { right: 22px; }
        
        .car-meta { font-size: 12px; color: #333333; font-weight: bold; flex-grow: 1; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .car-data-row { display: flex; align-items: center; gap: 12px; margin-top: 8px; font-size: 13px; color: #333333; }
        .stamp-small { height: 32px; }

        .history-section { border-top: 1px solid var(--sub-gray); margin-top: 20px; padding: 20px; }
        .history-item { margin-bottom: 18px; }
        .history-top-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .history-date { font-size: 13px; font-weight: bold; color: var(--text-main); white-space: nowrap; }
        .history-stamp { height: 26px; }
        .history-desc { font-size: 13px; color: #333; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="home-view">
    <div class="header">ホーム</div>
    <div id="accordion-container"></div>
</div>

<div id="formation-view" class="hidden">
    <div class="header" onclick="showHome()" style="cursor:pointer;">◀ <span id="formation-header-title">系統名</span></div>
    <div id="formation-accordion-container"></div>
</div>

<div id="detail-view" class="hidden">
    <div class="header" onclick="showFormation()" style="cursor:pointer;">◀ <span id="detail-header-title">編成名</span></div>
    <div class="detail-info-box">
        <div class="section-title">編成情報</div>
        <div class="info-row"><span class="info-label">車両形式</span> <span id="info-type"></span></div>
        <div class="info-row"><span class="info-label">所属基地</span> <span id="info-base"></span></div>
        <div class="info-row" id="atacs-row"><span class="info-label">ATACS-ID</span> <span id="info-atacs"></span></div>
        <div id="info-stamps" style="margin-top:12px; display:flex; align-items:center; gap:8px;"></div>
    </div>
    <div class="divider"></div>
    <div class="car-detail-list"><div id="car-details-container"></div></div>
    <div class="history-section">
        <div class="section-title" id="history-title">車歴</div>
        <div id="history-list"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
let formationData = [];
let carIdMap = {}; 
let historyData = []; 
let currentSystem = "";
let currentCars = [];
let fullHistoryEvents = []; 
const PANTA_MAP = { '◇': 'p0', '＜': 'p1', '＞': 'p2', '<': 'py1', '>': 'py2' };

function loadAllData() {
    return new Promise((resolve) => {
        Papa.parse('file - formation.csv', {
            download: true, header: true, skipEmptyLines: 'greedy',
            complete: function(fResults) {
                formationData = fResults.data.filter(r => r.会社名 && r.会社名.trim() !== "");
                
                Papa.parse('file - car_id.csv', {
                    download: true, header: true, skipEmptyLines: 'greedy',
                    complete: function(cResults) {
                        cResults.data.forEach(row => {
                            if(row['車両ID']) carIdMap[row['車両ID']] = row;
                        });

                        Papa.parse('file - history.csv', {
                            download: true, header: true, skipEmptyLines: 'greedy',
                            complete: function(hResults) {
                                historyData = hResults.data;
                                resolve();
                            }
                        });
                    }
                });
            }
        });
    });
}

loadAllData().then(() => {
    renderHome();
});

function formatDateJP(dateStr) {
    if (!dateStr || dateStr.trim() === "") return "";
    const parsePart = (part, context = {}) => {
        const segments = part.split('/');
        let y = context.y, m = context.m, d = context.d;
        if (segments.length === 3) {
            y = segments[0]; m = segments[1]; d = segments[2];
        } else if (segments.length === 2) {
            if (segments[0].length === 4) { y = segments[0]; m = segments[1]; d = null; }
            else { m = segments[0]; d = segments[1]; }
        } else if (segments.length === 1) { d = segments[0]; }
        return { y, m, d };
    };
    const stringify = (obj) => {
        let res = "";
        if (obj.y) res += obj.y + "年";
        if (obj.m) res += obj.m + "月";
        if (obj.d) res += obj.d + "日";
        return res;
    };
    if (dateStr.includes('-')) {
        const parts = dateStr.split('-');
        const start = parsePart(parts[0]);
        const end = parsePart(parts[1], start);
        return stringify(start) + "~" + stringify(end);
    } else {
        return stringify(parsePart(dateStr));
    }
}

function getStampsHTML(stampStr, className, folder = 'stamp') {
    if (!stampStr) return '';
    return stampStr.split(',').map(s => `<img src="${folder}/${s.trim()}.png" class="${className}" onerror="this.style.display='none'">`).join('');
}

function renderHome() {
    const container = document.getElementById('accordion-container');
    container.innerHTML = '';
    const companies = [...new Set(formationData.map(r => r.会社名))];
    companies.forEach(com => {
        const comId = `com-${com.replace(/\s+/g, '')}`;
        container.insertAdjacentHTML('beforeend', `
            <div class="system-section" onclick="toggleSection('${comId}', this)">
                <div class="system-title">${com}</div>
                <div class="arrow">▼</div>
            </div>
            <div id="${comId}" class="formation-list-bg">
                <div class="rows-container"></div>
            </div>`);
        const rowsContainer = container.querySelector(`#${comId} .rows-container`);
        const comData = formationData.filter(r => r.会社名 === com);
        const systems = [...new Set(comData.map(r => r.路線系統))];
        systems.forEach(sys => {
            const row = document.createElement('div');
            row.className = 'line-sys-row';
            row.innerText = sys;
            row.onclick = () => showFormationList(sys);
            rowsContainer.appendChild(row);
        });
    });
}

function showFormationList(sysName) {
    currentSystem = sysName;
    document.getElementById('home-view').classList.add('hidden');
    document.getElementById('formation-view').classList.remove('hidden');
    document.getElementById('formation-header-title').innerText = sysName;
    window.scrollTo(0,0);

    const fContainer = document.getElementById('formation-accordion-container');
    fContainer.innerHTML = '';
    
    const sysData = formationData.filter(r => r.路線系統 === sysName);
    const formKeys = [...new Set(sysData.map(r => `${r.形式}|${r.見出しアイコン || ''}`))];

    formKeys.forEach((key, index) => {
        const [formName, iconName] = key.split('|');
        const formId = `form-${index}-${formName.replace(/\s+/g, '')}`;
        const formData = sysData.filter(r => r.形式 === formName && (r.見出しアイコン || '') === iconName);
        const first = formData[0];

        fContainer.insertAdjacentHTML('beforeend', `
            <div class="system-section" onclick="toggleSection('${formId}', this)">
                <div class="system-title">
                    ${iconName ? `<img src="icon/${iconName}.png" class="system-icon">` : ''}
                    ${formName}
                </div>
                <div class="arrow">▼</div>
            </div>
            <div id="${formId}" class="formation-list-bg">
                <div class="direction-label"><span>◀︎${first.左方向||''}</span><span>${first.右方向||''}▶︎</span></div>
                <div class="rows-box"></div>
            </div>`);

        const rowsBox = fContainer.querySelector(`#${formId} .rows-box`);
        const namesWithPeriod = [...new Set(formData.map(r => `${r.編成名}|${r.始 || ''}|${r.終 || ''}|${r.会社名}`))];

        namesWithPeriod.forEach(keyStr => {
            const [name, start, end, company] = keyStr.split('|');
            const cars = formData.filter(r => r.編成名 === name && (r.始 || '') === start && (r.終 || '') === end && r.会社名 === company).sort((a,b) => a.号車 - b.号車);
            
            const row = document.createElement('div');
            row.className = 'formation-row';
            row.onclick = () => renderDetail(name, start, end, company);

            const periodLabel = (start || end) ? ` (${start||''}〜${end||''})` : '';
            let h = `<div class="f-name-tag">${name}${periodLabel}</div><div class="car-mini-list">`;
            cars.forEach(c => {
                const lp = PANTA_MAP[c.左パンタ];
                const rp = PANTA_MAP[c.右パンタ];
                const lastNo = c.車両番号 ? c.車両番号.split('-').pop() : "";
                h += `<div class="mini-car-container">
                    ${lp ? `<img src="parts/${lp}.png" class="mini-panta mini-panta-l ${lp === 'p0' ? 'panta-p0' : ''} ${lp.startsWith('py') ? 'low-panta' : ''}">` : ''}
                    ${rp ? `<img src="parts/${rp}.png" class="mini-panta mini-panta-r ${rp === 'p0' ? 'panta-p0' : ''} ${rp.startsWith('py') ? 'low-panta' : ''}">` : ''}
                    <div class="mini-car-body" style="background-image: url('body/${c.車体アイコン}.png');"></div>
                    <div class="mini-info-in-body">${c.略号||''}${lastNo}</div>
                    ${c.左台車 ? `<img src="parts/${c.左台車}.png" class="mini-bogie mini-bogie-l">` : ''}
                    ${c.右台車 ? `<img src="parts/${c.右台車}.png" class="mini-bogie mini-bogie-r">` : ''}
                </div>`;
            });
            row.innerHTML = h + `</div>`;
            rowsBox.appendChild(row);
        });
    });
}

function renderDetail(name, start, end, company) {
    document.getElementById('formation-view').classList.add('hidden');
    document.getElementById('detail-view').classList.remove('hidden');
    window.scrollTo(0,0);
    
    currentCars = formationData.filter(r => 
        r.編成名 === name && 
        (r.始 || '') === start && 
        (r.終 || '') === end && 
        r.路線系統 === currentSystem && 
        r.会社名 === company
    ).sort((a,b) => a.号車 - b.号車);
    const top = currentCars[0];

    document.getElementById('detail-header-title').innerText = name + ((start || end) ? ` (${start||''}〜${end||''})` : '');
    document.getElementById('info-type').innerText = `${top.形式} ${top.番台 || ''}`.trim();
    document.getElementById('info-base').innerText = top.所属基地;

    const atacsRow = document.getElementById('atacs-row');
    if (top["ATACS-ID"] && top["ATACS-ID"].trim() !== "") {
        atacsRow.classList.remove('hidden');
        document.getElementById('info-atacs').innerText = top["ATACS-ID"];
    } else {
        atacsRow.classList.add('hidden');
    }

    document.getElementById('info-stamps').innerHTML = getStampsHTML(top["編成情報(選択)"], 'stamp-icon-large');

    const cCon = document.getElementById('car-details-container');
    cCon.innerHTML = '<div class="section-title">車両情報</div>';
    
    const carIdsInFormation = []; 
    const historyPool = [];

    currentCars.forEach(c => {
        const carId = c.車両ID;
        carIdsInFormation.push(carId);
        
        const carMeta = carIdMap[carId] || {};
        const lp = PANTA_MAP[c.左パンタ];
        const rp = PANTA_MAP[c.右パンタ];

        if (carMeta.落成日 && carMeta.製造所) {
            historyPool.push({
                date: carMeta.落成日,
                stamp: 'rakusei',
                desc: `${carMeta.製造所}にて落成。`,
                carId: carId,
                carNo: c.車両番号
            });
        }

        cCon.innerHTML += `<div class="car-unit">
            <div class="car-visual-row">
                <div class="car-img-container" onclick="filterHistoryByCar('${carId}', '${c.車両番号}')">
                    ${lp ? `<img src="parts/${lp}.png" class="panta-detail panta-left ${lp === 'p0' ? 'panta-p0' : ''} ${lp.startsWith('py') ? 'low-panta' : ''}">` : ''}
                    ${rp ? `<img src="parts/${rp}.png" class="panta-detail panta-right ${rp === 'p0' ? 'panta-p0' : ''} ${rp.startsWith('py') ? 'low-panta' : ''}">` : ''}
                    <div class="detail-car-body" style="background-image: url('body/${c.車体アイコン}.png');"></div>
                    <div class="car-no-inline">${c.車両番号}</div>
                    ${c.左台車?`<img src="parts/${c.左台車}.png" class="bogie bogie-left">`:''}
                    ${c.右台車?`<img src="parts/${c.右台車}.png" class="bogie bogie-right">`:''}
                </div>
                <div class="car-meta">
                    <div>${carMeta.製造所 || ''}</div>
                    <div>${formatDateJP(carMeta.落成日)}</div>
                </div>
            </div>
            <div class="car-data-row">
                <div class="stamp-container">${getStampsHTML(c["車両情報(選択)"],'stamp-small')}</div>
                <div class="car-desc">${c["車両情報(記述)"] || ''}</div>
            </div>
        </div>`;
    });

    historyData.forEach(ev => {
        const eventCarIds = [];
        Object.keys(ev).forEach(key => {
            if(key.startsWith('車両ID-') && ev[key] && carIdsInFormation.includes(ev[key])) {
                eventCarIds.push(ev[key]);
            }
        });
        if (eventCarIds.length > 0) {
            historyPool.push({
                date: ev.日付,
                stamp: ev.スタンプ,
                desc: ev.記述 || "",
                carIds: eventCarIds
            });
        }
    });

    historyPool.sort((a, b) => (a.date || "").replace(/\//g,'').localeCompare((b.date || "").replace(/\//g,'')));
    
    fullHistoryEvents = [];
    historyPool.forEach(item => {
        const prev = fullHistoryEvents[fullHistoryEvents.length - 1];
        if (prev && prev.date === item.date && prev.desc === item.desc && prev.stamp === item.stamp) {
            if (item.carNo) prev.carNos.push(item.carNo);
            if (item.carIds) item.carIds.forEach(id => { if(!prev.carIds.includes(id)) prev.carIds.push(id); });
        } else {
            fullHistoryEvents.push({
                ...item,
                carNos: item.carNo ? [item.carNo] : [],
                carIds: item.carIds || [item.carId]
            });
        }
    });

    renderHistoryList(fullHistoryEvents);
}

function renderHistoryList(events, title = "車歴", isFiltered = false) {
    document.getElementById('history-title').innerText = title;
    const hList = document.getElementById('history-list');
    hList.innerHTML = '';

    events.forEach(ev => {
        const targetCarNos = ev.carNos && ev.carNos.length > 0 ? ev.carNos : currentCars.filter(c => ev.carIds.includes(c.車両ID)).map(c => c.車両番号);
        
        const suffix = (isFiltered || targetCarNos.length === currentCars.length) ? "" : ` (${targetCarNos.join(', ')})`;
        
        hList.innerHTML += `
            <div class="history-item">
                <div class="history-top-row">
                    <div class="history-date">${formatDateJP(ev.date)}</div>
                    <div class="history-stamp-container">${getStampsHTML(ev.stamp, 'history-stamp', 'history')}</div>
                </div>
                <div class="history-desc">${ev.desc + suffix}</div>
            </div>`;
    });
}

function filterHistoryByCar(carId, carNo) {
    const filtered = fullHistoryEvents.filter(ev => ev.carIds.includes(carId));
    renderHistoryList(filtered, `車歴 (${carNo})`, true);
    document.querySelector('.history-section').scrollIntoView({ behavior: 'smooth' });
}

function toggleSection(id, el) {
    const list = document.getElementById(id);
    const isShow = list.classList.toggle('show');
    el.querySelector('.arrow').innerText = isShow ? '▲' : '▼';
}

function showHome() {
    document.getElementById('home-view').classList.remove('hidden');
    document.getElementById('formation-view').classList.add('hidden');
    document.getElementById('detail-view').classList.add('hidden');
}

function showFormation() {
    document.getElementById('formation-view').classList.remove('hidden');
    document.getElementById('detail-view').classList.add('hidden');
}
</script>
</body>
</html>
